{{!-- NPC Creation Wizard Content --}}
<section class="creation-content npc-creation-content">
  <div class="creation-step-content">
    {{!-- Step 1: Class & Type --}}
    {{#if (eq stepId "classType")}}
    <div class="step-classtype">
      <h2>{{localize "AOA.NPCCreation.Step.ClassType"}}</h2>
      <p class="step-description">{{localize "AOA.NPCCreation.ClassTypeDesc"}}</p>

      {{!-- Class Selection --}}
      <div class="selection-section">
        <h3>{{localize "AOA.NPCCreation.SelectClass"}}</h3>
        <div class="class-grid">
          {{#each classes}}
          <div class="class-card {{#if selected}}selected{{/if}}" data-action="selectClass" data-class-id="{{id}}">
            <i class="{{icon}}"></i>
            <span class="class-name">{{localizedLabel}}</span>
          </div>
          {{/each}}
        </div>
      </div>

      {{!-- Type Selection (shown when Class is selected) --}}
      {{#if selectedClass}}
      <div class="selection-section">
        <h3>{{localize "AOA.NPCCreation.SelectType"}}</h3>
        <div class="type-grid">
          {{#each types}}
          <div class="type-card {{#if selected}}selected{{/if}}" data-action="selectType" data-type-id="{{id}}">
            <span class="type-name">{{localizedLabel}}</span>
          </div>
          {{/each}}
        </div>
      </div>
      {{/if}}
    </div>
    {{/if}}

    {{!-- Step 2: Tier Selection --}}
    {{#if (eq stepId "tier")}}
    <div class="step-tier">
      <h2>{{localize "AOA.NPCCreation.Step.Tier"}}</h2>
      <p class="step-description">{{localize "AOA.NPCCreation.TierDesc"}}</p>

      <div class="tier-grid">
        {{#each tiers}}
        <div class="tier-card {{#if selected}}selected{{/if}}" data-action="selectTier" data-tier-id="{{id}}">
          <div class="tier-header">
            <span class="tier-id">{{id}}</span>
            <span class="tier-name">{{localizedLabel}}</span>
          </div>
          <div class="tier-stats">
            <div class="tier-stat">
              <span class="stat-label">{{localize "AOA.NPCCreation.BaseDicePool"}}</span>
              <span class="stat-value">{{baseDicePool}}d6</span>
            </div>
            <div class="tier-stat">
              <span class="stat-label">{{localize "AOA.NPCCreation.TraitPoints"}}</span>
              <span class="stat-value">{{traitPoints}}</span>
            </div>
          </div>
          <p class="tier-description">{{localizedDesc}}</p>
        </div>
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{!-- Step 3: Attributes --}}
    {{#if (eq stepId "attributes")}}
    <div class="step-attributes">
      <h2>{{localize "AOA.NPCCreation.Step.Attributes"}}</h2>
      <p class="step-description">{{localize "AOA.NPCCreation.AttributesDesc"}}</p>

      {{!-- Points Counter --}}
      <div class="points-counter">
        <span class="points-label">{{localize "AOA.NPCCreation.PointsRemaining"}}:</span>
        <span class="points-value {{#if (lt attributePointsRemaining 0)}}over-budget{{/if}}">
          {{attributePointsRemaining}} / {{attributePointsTotal}}
        </span>
        <span class="points-hint">({{localize "AOA.NPCCreation.MaxPerAttribute"}}: {{attributeMax}})</span>
      </div>

      {{!-- Attribute Templates --}}
      <div class="templates-section">
        <h3>{{localize "AOA.NPCCreation.AttributeTemplates"}}</h3>
        <div class="template-buttons">
          {{#each attributeTemplates}}
          <button type="button" class="template-btn {{#if (eq ../selectedAttributeTemplate @key)}}selected{{/if}}"
                  data-action="selectAttributeTemplate" data-template="{{@key}}">
            {{localize label}}
          </button>
          {{/each}}
        </div>
      </div>

      {{!-- Attribute Grid --}}
      <div class="attributes-grid">
        {{#each attributeList}}
        <div class="attribute-row">
          <span class="attribute-label">{{localize label}}</span>
          <div class="attribute-controls">
            <button type="button" class="adjust-btn minus" data-action="adjustAttribute" data-attribute="{{key}}" data-adjust="-1">
              <i class="fas fa-minus"></i>
            </button>
            <span class="attribute-value">{{lookup ../npcData.attributes key}}</span>
            <button type="button" class="adjust-btn plus" data-action="adjustAttribute" data-attribute="{{key}}" data-adjust="1">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{!-- Step 4: Skills --}}
    {{#if (eq stepId "skills")}}
    <div class="step-skills">
      <h2>{{localize "AOA.NPCCreation.Step.Skills"}}</h2>
      <p class="step-description">{{localize "AOA.NPCCreation.SkillsDesc"}}</p>

      {{!-- Ranks Counter --}}
      <div class="points-counter">
        <span class="points-label">{{localize "AOA.NPCCreation.RanksRemaining"}}:</span>
        <span class="points-value {{#if (lt skillRanksRemaining 0)}}over-budget{{/if}}">
          {{skillRanksRemaining}} / {{skillRanksTotal}}
        </span>
      </div>

      {{!-- Skill Templates --}}
      <div class="templates-section">
        <h3>{{localize "AOA.NPCCreation.SkillTemplates"}}</h3>
        <div class="template-buttons">
          {{#each skillTemplates}}
          <button type="button" class="template-btn {{#if (eq ../selectedSkillTemplate @key)}}selected{{/if}}"
                  data-action="selectSkillTemplate" data-template="{{@key}}">
            {{localize label}}
          </button>
          {{/each}}
        </div>
      </div>

      {{!-- Skills by Category --}}
      <div class="skills-categories">
        {{#each skillsByCategory}}
        {{#if this.length}}
        <div class="skill-category">
          <h4>{{localize (concat "AOA.SkillCategory." (capitalize @key))}}</h4>
          <div class="skills-list">
            {{#each this}}
            <div class="skill-row">
              <span class="skill-name">{{name}}</span>
              <div class="skill-controls">
                <button type="button" class="adjust-btn minus" data-action="removeSkillRank" data-skill="{{name}}">
                  <i class="fas fa-minus"></i>
                </button>
                <span class="skill-rank">{{#with (lookup ../../characterSkills name)}}{{this}}{{else}}0{{/with}}</span>
                <button type="button" class="adjust-btn plus" data-action="addSkillRank" data-skill="{{name}}">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            {{/each}}
          </div>
        </div>
        {{/if}}
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{!-- Step 5: Traits --}}
    {{#if (eq stepId "traits")}}
    <div class="step-traits">
      <h2>{{localize "AOA.NPCCreation.Step.Traits"}}</h2>
      <p class="step-description">{{localize "AOA.NPCCreation.TraitsDesc"}}</p>

      {{!-- Points Counter --}}
      <div class="points-counter">
        <span class="points-label">{{localize "AOA.NPCCreation.TraitPointsRemaining"}}:</span>
        <span class="points-value {{#if (lt traitPointsRemaining 0)}}over-budget{{/if}}">
          {{traitPointsRemaining}} / {{traitPointsTotal}}
        </span>
      </div>

      <div class="traits-layout">
        {{!-- Selected Traits Panel --}}
        <div class="selected-traits-panel">
          <h3>{{localize "AOA.NPCCreation.SelectedTraits"}}</h3>
          {{#if selectedTraits.length}}
          <div class="selected-traits-list">
            {{#each selectedTraits}}
            <div class="selected-trait">
              <img src="{{img}}" alt="{{name}}" class="trait-img">
              <span class="trait-name">{{name}}</span>
              <span class="trait-cost">{{cost}}</span>
              <button type="button" class="remove-btn" data-action="removeTrait" data-trait-id="{{id}}">
                <i class="fas fa-times"></i>
              </button>
            </div>
            {{/each}}
          </div>
          {{else}}
          <p class="no-traits">{{localize "AOA.NPCCreation.NoTraitsSelected"}}</p>
          {{/if}}
        </div>

        {{!-- Available Traits Browser --}}
        <div class="traits-browser">
          <h3>{{localize "AOA.NPCCreation.AvailableTraits"}}</h3>

          {{!-- Category Filter --}}
          <div class="trait-category-filters">
            <button type="button" class="trait-category-btn {{#if (eq traitCategoryFilter 'all')}}active{{/if}}"
                    data-category="all">
              {{localize "AOA.Common.All"}}
            </button>
            {{#each traitCategories}}
            <button type="button" class="trait-category-btn {{#if (eq ../traitCategoryFilter id)}}active{{/if}}"
                    data-category="{{id}}">
              <i class="{{icon}}"></i>
              {{localizedLabel}}
            </button>
            {{/each}}
          </div>

          {{!-- Type-Specific Traits (if any) --}}
          {{#if typeSpecificTraits.length}}
          <div class="type-specific-section">
            <h4>{{localize "AOA.NPCCreation.TypeSpecificTraits"}}</h4>
            <div class="traits-grid">
              {{#each typeSpecificTraits}}
              <div class="trait-card {{#if selected}}selected{{/if}} type-specific" data-category="{{system.category}}">
                <div class="trait-header">
                  <img src="{{img}}" alt="{{name}}" class="trait-img">
                  <span class="trait-name">{{name}}</span>
                  <span class="trait-cost">{{system.cost}}</span>
                </div>
                <p class="trait-description">{{system.description}}</p>
                {{#unless selected}}
                <button type="button" class="add-trait-btn" data-action="addTrait" data-trait-id="{{id}}">
                  <i class="fas fa-plus"></i> {{localize "AOA.Common.Add"}}
                </button>
                {{/unless}}
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{!-- General Traits --}}
          <div class="general-traits-section">
            {{#if typeSpecificTraits.length}}
            <h4>{{localize "AOA.NPCCreation.GeneralTraits"}}</h4>
            {{/if}}
            <div class="traits-grid">
              {{#each generalTraits}}
              <div class="trait-card {{#if selected}}selected{{/if}}" data-category="{{system.category}}">
                <div class="trait-header">
                  <img src="{{img}}" alt="{{name}}" class="trait-img">
                  <span class="trait-name">{{name}}</span>
                  <span class="trait-cost">{{system.cost}}</span>
                </div>
                <p class="trait-description">{{system.description}}</p>
                {{#unless selected}}
                <button type="button" class="add-trait-btn" data-action="addTrait" data-trait-id="{{id}}">
                  <i class="fas fa-plus"></i> {{localize "AOA.Common.Add"}}
                </button>
                {{/unless}}
              </div>
              {{/each}}
            </div>
          </div>
        </div>
      </div>
    </div>
    {{/if}}

    {{!-- Step 6: Finalization --}}
    {{#if (eq stepId "finalize")}}
    <div class="step-finalize">
      <h2>{{localize "AOA.NPCCreation.Step.Finalize"}}</h2>

      <div class="finalize-layout">
        {{!-- Left Panel: Name & Equipment --}}
        <div class="finalize-inputs">
          {{!-- Name Input --}}
          <div class="name-section">
            <label for="npc-name">{{localize "AOA.NPCCreation.NPCName"}}</label>
            <input type="text" id="npc-name" name="name" value="{{npcData.name}}"
                   placeholder="{{localize 'AOA.NPCCreation.EnterName'}}">
          </div>

          {{!-- Notes --}}
          <div class="notes-section">
            <label for="npc-notes">{{localize "AOA.NPCCreation.Notes"}}</label>
            <textarea id="npc-notes" name="notes" rows="3"
                      placeholder="{{localize 'AOA.NPCCreation.NotesPlaceholder'}}">{{npcData.notes}}</textarea>
          </div>

          {{!-- Equipment Section --}}
          <div class="equipment-section">
            <h3>{{localize "AOA.NPCCreation.Equipment"}}</h3>

            {{!-- Gear Tabs --}}
            <div class="gear-tabs">
              <button type="button" class="gear-tab-btn {{#if (eq gearTab 'weapons')}}active{{/if}}" data-gear-tab="weapons">
                {{localize "AOA.ItemType.Weapon"}}
              </button>
              <button type="button" class="gear-tab-btn {{#if (eq gearTab 'armor')}}active{{/if}}" data-gear-tab="armor">
                {{localize "AOA.ItemType.Armor"}}
              </button>
              <button type="button" class="gear-tab-btn {{#if (eq gearTab 'gear')}}active{{/if}}" data-gear-tab="gear">
                {{localize "AOA.ItemType.Gear"}}
              </button>
            </div>

            {{!-- Gear Panels --}}
            <div class="gear-tab-panel {{#if (eq gearTab 'weapons')}}active{{/if}}" data-gear-tab-panel="weapons">
              <div class="gear-grid">
                {{#each availableWeapons}}
                <div class="gear-card" data-group="{{system.group}}">
                  <img src="{{img}}" alt="{{name}}" class="gear-img">
                  <span class="gear-name">{{name}}</span>
                  <button type="button" class="add-gear-btn" data-action="purchaseGear" data-item-id="{{id}}">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                {{/each}}
              </div>
            </div>

            <div class="gear-tab-panel {{#if (eq gearTab 'armor')}}active{{/if}}" data-gear-tab-panel="armor">
              <div class="gear-grid">
                {{#each availableArmor}}
                <div class="gear-card" data-group="{{system.category}}">
                  <img src="{{img}}" alt="{{name}}" class="gear-img">
                  <span class="gear-name">{{name}}</span>
                  <button type="button" class="add-gear-btn" data-action="purchaseGear" data-item-id="{{id}}">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                {{/each}}
              </div>
            </div>

            <div class="gear-tab-panel {{#if (eq gearTab 'gear')}}active{{/if}}" data-gear-tab-panel="gear">
              <div class="gear-grid">
                {{#each availableGear}}
                <div class="gear-card" data-group="{{system.category}}">
                  <img src="{{img}}" alt="{{name}}" class="gear-img">
                  <span class="gear-name">{{name}}</span>
                  <button type="button" class="add-gear-btn" data-action="purchaseGear" data-item-id="{{id}}">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                {{/each}}
              </div>
            </div>

            {{!-- Selected Equipment --}}
            {{#if selectedEquipment.length}}
            <div class="selected-equipment">
              <h4>{{localize "AOA.NPCCreation.SelectedEquipment"}}</h4>
              <div class="selected-equipment-list">
                {{#each selectedEquipment}}
                <div class="selected-equipment-item">
                  <img src="{{img}}" alt="{{name}}" class="equip-img">
                  <span class="equip-name">{{name}}</span>
                  <button type="button" class="remove-btn" data-action="removeGear" data-index="{{@index}}">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                {{/each}}
              </div>
            </div>
            {{/if}}
          </div>
        </div>

        {{!-- Right Panel: Summary --}}
        <div class="npc-summary">
          <h3>{{localize "AOA.NPCCreation.Summary"}}</h3>

          <div class="summary-section">
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPC.Class.Label"}}:</span>
              <span class="summary-value">{{npcSummary.npcClass}}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPC.Type.Label"}}:</span>
              <span class="summary-value">{{npcSummary.npcType}}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPC.Tier.Label"}}:</span>
              <span class="summary-value">{{npcSummary.tier}} ({{npcSummary.tierName}})</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPCCreation.BaseDicePool"}}:</span>
              <span class="summary-value">{{npcSummary.baseDicePool}}d6</span>
            </div>
          </div>

          <div class="summary-section">
            <h4>{{localize "AOA.CharacterCreation.Step.Attributes"}}</h4>
            <div class="summary-attributes">
              {{#each npcSummary.attributes}}
              <div class="summary-attr">
                <span class="attr-abbr">{{localize (concat "AOA.Attribute." (capitalize @key) ".abbr")}}</span>
                <span class="attr-value">{{this}}</span>
              </div>
              {{/each}}
            </div>
          </div>

          <div class="summary-section">
            <h4>{{localize "AOA.Derived.Title"}}</h4>
            <div class="summary-derived">
              <div class="derived-row">
                <span>{{localize "AOA.Derived.Defense.label"}}:</span>
                <span>{{npcSummary.derived.defense}}</span>
              </div>
              <div class="derived-row">
                <span>{{localize "AOA.Derived.Movement.label"}}:</span>
                <span>{{npcSummary.derived.movement}}</span>
              </div>
              <div class="derived-row">
                <span>{{localize "AOA.Derived.MaxTrauma.label"}}:</span>
                <span>{{npcSummary.derived.maxTrauma}}</span>
              </div>
              <div class="derived-row">
                <span>{{localize "AOA.Derived.Wounds.label"}}:</span>
                <span>{{npcSummary.derived.wounds}}</span>
              </div>
            </div>
          </div>

          <div class="summary-section">
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPCCreation.Skills"}}:</span>
              <span class="summary-value">{{npcSummary.skillCount}}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPCCreation.Traits"}}:</span>
              <span class="summary-value">{{npcSummary.traitCount}} ({{npcSummary.traitPointsSpent}}/{{npcSummary.traitPointsTotal}} pts)</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{localize "AOA.NPCCreation.Equipment"}}:</span>
              <span class="summary-value">{{npcSummary.equipmentCount}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    {{/if}}
  </div>
</section>
