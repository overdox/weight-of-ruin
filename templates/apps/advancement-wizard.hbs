{{!-- Advancement Wizard Template --}}
{{!-- Matches character creation wizard structure --}}
<div class="advancement-wizard-container">

{{!-- HEADER --}}
<header class="creation-header">
  <div class="creation-title">
    <h1>{{localize "AOA.Advancement.Wizard.Title"}}</h1>
  </div>

  {{!-- Step Progress Indicator --}}
  <nav class="step-progress">
    {{#each steps}}
    <div class="step-indicator {{#if active}}active{{/if}} {{#if completed}}completed{{/if}} {{#if future}}future{{/if}}"
         title="{{localize label}}">
      <span class="step-number">{{number}}</span>
      {{#if completed}}
      <i class="fas fa-check"></i>
      {{/if}}
    </div>
    {{/each}}
  </nav>

  {{!-- XP Cost Tracker --}}
  <div class="lp-tracker">
    <span class="lp-label">{{localize "AOA.Advancement.XP.label"}}:</span>
    <span class="lp-value">
      <span class="lp-remaining">{{actor.system.advancement.xp.current}}</span>
      <span class="lp-total">(-1000)</span>
    </span>
  </div>
</header>

{{!-- BODY --}}
<section class="creation-body">

  {{!-- ============================================ --}}
  {{!-- ATTRIBUTE STEP --}}
  {{!-- ============================================ --}}
  {{#if (eq currentStep "attribute")}}
  <div class="step-header">
    <h2>
      <i class="fas fa-fist-raised"></i>
      {{localize "AOA.Advancement.Wizard.Attribute"}}
    </h2>
  </div>
  <div class="creation-step-content">
    <p class="step-description">{{localize "AOA.Advancement.Wizard.AttributeDescription"}}</p>

    <div class="attribute-selection-grid">
      {{#each stepContext.attributes}}
      <div class="attribute-card {{#if selected}}selected{{/if}} {{#if maxReached}}disabled{{/if}}"
           data-action="selectAttribute"
           data-attribute="{{key}}"
           {{#if maxReached}}title="Maximum reached"{{/if}}>
        <div class="attribute-card-header">
          <span class="attr-abbr">{{abbr}}</span>
          <span class="attr-name">{{label}}</span>
        </div>
        <div class="attribute-card-value">
          <span class="current-value">{{current}}</span>
          {{#if selected}}
          <i class="fas fa-arrow-right advance-arrow"></i>
          <span class="new-value">{{add current 1}}</span>
          {{/if}}
        </div>
        {{#if selected}}
        <div class="selected-indicator">
          <i class="fas fa-check"></i>
        </div>
        {{/if}}
      </div>
      {{/each}}
    </div>
  </div>
  {{/if}}

  {{!-- ============================================ --}}
  {{!-- SKILLS STEP --}}
  {{!-- ============================================ --}}
  {{#if (eq currentStep "skills")}}
  <div class="step-header">
    <h2>
      <i class="fas fa-graduation-cap"></i>
      {{localize "AOA.Advancement.Wizard.Skills"}}
    </h2>
  </div>
  <div class="creation-step-content">
    <p class="step-description">{{localize "AOA.Advancement.Wizard.SkillsDescription"}}</p>

    <div class="selection-counter">
      <span class="counter-label">{{localize "AOA.Advancement.Wizard.Selected"}}:</span>
      <span class="counter-value {{#if (eq stepContext.remainingSkills 0)}}complete{{/if}}">
        {{subtract 3 stepContext.remainingSkills}} / 3
      </span>
    </div>

    <div class="skills-selection-container">
      {{#each stepContext.skills}}
      {{#if this.length}}
      <div class="skill-category-group">
        <h4 class="category-header">{{localize (concat "AOA.SkillCategory." (capitalize @key))}}</h4>
        <div class="skill-options-grid">
          {{#each this}}
          <div class="skill-option-card {{#if selected}}selected{{/if}} {{#if maxReached}}disabled{{/if}}"
               data-action="toggleSkill"
               data-skill="{{name}}"
               {{#if maxReached}}title="Maximum rank reached"{{/if}}>
            <span class="skill-name">{{name}}</span>
            <span class="skill-rank-display">
              <span class="current-rank">{{currentRank}}</span>
              {{#if selected}}
              <i class="fas fa-arrow-right"></i>
              <span class="new-rank">{{add currentRank 1}}</span>
              {{/if}}
            </span>
            {{#if selected}}
            <i class="fas fa-check selected-check"></i>
            {{/if}}
          </div>
          {{/each}}
        </div>
      </div>
      {{/if}}
      {{/each}}
    </div>
  </div>
  {{/if}}

  {{!-- ============================================ --}}
  {{!-- TALENT STEP --}}
  {{!-- ============================================ --}}
  {{#if (eq currentStep "talent")}}
  <div class="step-header">
    <h2>
      <i class="fas fa-star"></i>
      {{localize "AOA.Advancement.Wizard.Talent"}}
    </h2>
  </div>
  <div class="creation-step-content">
    <p class="step-description">{{localize "AOA.Advancement.Wizard.TalentDescription"}}</p>

    {{!-- Talent Mode Selection --}}
    <div class="talent-mode-tabs">
      <button type="button" class="mode-tab {{#if (eq stepContext.talentMode 'advance')}}active{{/if}}"
              data-action="selectTalentMode" data-mode="advance"
              {{#unless stepContext.existingTalents.length}}disabled{{/unless}}>
        <i class="fas fa-arrow-up"></i>
        {{localize "AOA.Advancement.Wizard.AdvanceTalent"}}
      </button>
      <button type="button" class="mode-tab {{#if (eq stepContext.talentMode 'purchase')}}active{{/if}}"
              data-action="selectTalentMode" data-mode="purchase">
        <i class="fas fa-plus"></i>
        {{localize "AOA.Advancement.Wizard.PurchaseTalent"}}
      </button>
    </div>

    {{!-- Advance Existing Talent --}}
    {{#if (eq stepContext.talentMode "advance")}}
    <div class="talent-selection-list">
      {{#if stepContext.existingTalents.length}}
      <div class="talent-options-grid">
        {{#each stepContext.existingTalents}}
        {{#if canAdvance}}
        <div class="talent-option-card {{#if selected}}selected{{/if}}"
             data-action="selectTalent" data-talent-id="{{id}}">
          <span class="talent-name">{{name}}</span>
          <span class="talent-rank-display">
            Rank {{currentRank}}
            {{#if selected}}
            <i class="fas fa-arrow-right"></i>
            {{add currentRank 1}}
            {{/if}}
          </span>
          {{#if selected}}
          <i class="fas fa-check selected-check"></i>
          {{/if}}
        </div>
        {{else}}
        <div class="talent-option-card disabled" title="Maximum rank reached">
          <span class="talent-name">{{name}}</span>
          <span class="talent-rank-display max">Rank {{currentRank}} / {{maxRank}}</span>
        </div>
        {{/if}}
        {{/each}}
      </div>
      {{else}}
      <p class="empty-message">No talents available to advance.</p>
      {{/if}}
    </div>
    {{/if}}

    {{!-- Purchase New Talent --}}
    {{#if (eq stepContext.talentMode "purchase")}}
    <div class="talent-selection-list">
      {{#if stepContext.availableTalents.length}}
      <div class="talent-options-grid">
        {{#each stepContext.availableTalents}}
        <div class="talent-option-card {{#if selected}}selected{{/if}}"
             data-action="selectTalent" data-talent-id="{{id}}">
          <span class="talent-name">{{name}}</span>
          <span class="talent-type-badge">{{type}}</span>
          {{#if selected}}
          <i class="fas fa-check selected-check"></i>
          {{/if}}
        </div>
        {{/each}}
      </div>
      {{else}}
      <p class="empty-message">No new talents available to purchase.</p>
      {{/if}}
    </div>
    {{/if}}
  </div>
  {{/if}}

</section>

{{!-- FOOTER --}}
<footer class="creation-footer">
  <div class="footer-info">
    <span class="step-info">
      {{localize "AOA.Advancement.Wizard.Step"}} {{currentStepNumber}} / 3
    </span>
  </div>

  <div class="footer-actions">
    {{#if canGoBack}}
    <button type="button" class="back-btn" data-action="prevStep">
      <i class="fas fa-arrow-left"></i>
      {{localize "AOA.Advancement.Wizard.Previous"}}
    </button>
    {{/if}}

    <button type="button" class="back-btn" data-action="cancel">
      {{localize "AOA.Advancement.Wizard.Cancel"}}
    </button>

    {{#if isLastStep}}
    <button type="button" class="finalize-btn {{#unless canComplete}}disabled{{/unless}}"
            data-action="completeAdvancement" {{#unless canComplete}}disabled{{/unless}}>
      <i class="fas fa-check"></i>
      {{localize "AOA.Advancement.Wizard.Complete"}}
    </button>
    {{else}}
    <button type="button" class="next-btn {{#unless canGoForward}}disabled{{/unless}}"
            data-action="nextStep" {{#unless canGoForward}}disabled{{/unless}}>
      {{localize "AOA.Advancement.Wizard.Next"}}
      <i class="fas fa-arrow-right"></i>
    </button>
    {{/if}}
  </div>
</footer>

</div>
