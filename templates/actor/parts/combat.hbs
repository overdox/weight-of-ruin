<section class="combat-section">
  {{!-- Combat Overview --}}
  <div class="combat-overview">
    <h3>{{localize "WOR.Section.CombatStats"}}</h3>
    <div class="combat-stats-grid">
      <div class="combat-stat">
        <span class="stat-label">{{localize "WOR.Derived.Defense.label"}}</span>
        <span class="stat-value">{{totalDefense}}</span>
        {{#if armorDefenseModifier}}
        <span class="stat-breakdown">({{defense}} base + {{armorDefenseModifier}} armor)</span>
        {{/if}}
      </div>
      <div class="combat-stat dr-stat">
        <span class="stat-label">{{localize "WOR.Combat.DamageReduction"}}</span>
        <span class="stat-value dr-display">
          <span class="dr-type" title="{{localize 'WOR.Armor.DR.Slash'}}">S:{{armorDR.slash}}</span>
          <span class="dr-type" title="{{localize 'WOR.Armor.DR.Pierce'}}">P:{{armorDR.pierce}}</span>
          <span class="dr-type" title="{{localize 'WOR.Armor.DR.Blunt'}}">B:{{armorDR.blunt}}</span>
        </span>
      </div>
      <div class="combat-stat">
        <span class="stat-label">{{localize "WOR.Derived.Movement.label"}}</span>
        <span class="stat-value">{{effectiveMovement}}</span>
        {{#if armorMovementPenalty}}
        <span class="stat-breakdown">({{movement}} base - {{armorMovementPenalty}} penalty)</span>
        {{/if}}
      </div>
      <div class="combat-stat">
        <span class="stat-label">{{localize "WOR.Derived.Reflex.label"}}</span>
        <span class="stat-value">{{reflex}}</span>
      </div>
    </div>

    {{!-- Initiative Roll Button --}}
    <div class="initiative-roll-section">
      <button type="button" class="initiative-button rollable" data-action="rollInitiative">
        <i class="fas fa-bolt"></i>
        {{localize "WOR.Combat.RollInitiative"}}
      </button>
      <span class="initiative-hint">1d6 + {{localize "WOR.Derived.Reflex.abbr"}} ({{reflex}})</span>
    </div>
  </div>

  {{!-- Active Conditions --}}
  <div class="conditions-section">
    <div class="conditions-header">
      <h4>{{localize "WOR.Condition.ActiveConditions"}}</h4>
      <button type="button" class="condition-reference-btn" data-action="openConditionReference" title="{{localize 'WOR.Condition.Reference'}}">
        <i class="fas fa-book-medical"></i>
      </button>
    </div>
    {{#if hasConditions}}
    <ul class="condition-list">
      {{#each conditions}}
      <li class="condition-item" data-condition-id="{{id}}">
        <img src="{{icon}}" class="condition-icon" alt="{{label}}" width="24" height="24"/>
        <div class="condition-info">
          <span class="condition-name">{{label}}</span>
          {{#if duration}}
          <span class="condition-duration">
            <i class="fas fa-clock"></i> {{duration}} {{localize "WOR.Condition.Rounds"}}
          </span>
          {{/if}}
        </div>
        <div class="condition-actions">
          <a class="condition-remove" data-action="removeCondition" data-condition-id="{{id}}" title="{{localize 'WOR.Common.Remove'}}">
            <i class="fas fa-times"></i>
          </a>
        </div>
      </li>
      {{/each}}
    </ul>
    {{else}}
    <p class="no-conditions">{{localize "WOR.Condition.NoActiveConditions"}}</p>
    {{/if}}
  </div>

  {{!-- Equipped Weapons for Attack --}}
  <div class="equipped-weapons-section">
    <h3>{{localize "WOR.Combat.EquippedWeapons"}}</h3>
    {{#if equippedWeapons.length}}
    <ul class="equipped-weapon-list">
      {{#each equippedWeapons}}
      <li class="equipped-weapon-item" data-item-id="{{_id}}">
        <div class="weapon-info">
          <span class="weapon-name">{{name}}</span>
          <div class="weapon-stats">
            <span class="weapon-damage" title="{{localize 'WOR.Weapon.Damage'}}">
              <i class="fas fa-tint"></i> {{system.displayDamage}}
            </span>
            <span class="weapon-prowess" title="{{localize 'WOR.Weapon.ProwessLabel'}}">
              {{localize (concat "WOR.Derived." (capitalize system.prowess) ".abbr")}}
            </span>
            {{#if system.range.type}}
            <span class="weapon-range" title="{{localize 'WOR.Weapon.Range'}}">
              {{localize (concat "WOR.Weapon.RangeType." (capitalize system.range.type))}}
            </span>
            {{/if}}
          </div>
        </div>
        <div class="weapon-actions">
          <button type="button" class="attack-button rollable" data-action="useItem" title="{{localize 'WOR.Combat.AttackWith' weapon=name}}">
            <i class="fas fa-crosshairs"></i>
            {{localize "WOR.Combat.Attack"}}
          </button>
          <button type="button" class="damage-button rollable" data-action="rollDamage" title="{{localize 'WOR.Combat.RollDamage'}}">
            <i class="fas fa-dice-d6"></i>
            {{localize "WOR.Combat.Damage"}}
          </button>
        </div>
      </li>
      {{/each}}
    </ul>
    {{else}}
    <div class="no-weapons-equipped">
      <p class="empty-notice">{{localize "WOR.Combat.NoWeaponsEquipped"}}</p>
      <p class="equip-hint">{{localize "WOR.Combat.EquipWeaponsHint"}}</p>
    </div>
    {{/if}}
  </div>

  {{!-- Defense Roll Section --}}
  <div class="defense-roll-section">
    <h3>{{localize "WOR.Combat.Defense"}}</h3>
    {{#if fullDefenseActive}}
    <div class="full-defense-active">
      <i class="fas fa-shield-alt"></i>
      <span>{{localize "WOR.Defense.FullDefense.Active"}} (+5)</span>
    </div>
    {{/if}}
    <div class="defense-pool-preview">
      <span class="pool-label">{{localize "WOR.Defense.BasePool"}}:</span>
      <span class="pool-value">{{reflex}}</span>
      <span class="pool-breakdown">({{localize "WOR.Attribute.Agility.abbr"}} + {{localize "WOR.Attribute.Awareness.abbr"}})</span>
    </div>
    <div class="defense-buttons">
      <button type="button" class="defense-button rollable" data-action="rollDefense">
        <i class="fas fa-shield-alt"></i>
        {{localize "WOR.Combat.RollDefense"}}
      </button>
      <button type="button" class="full-defense-button {{#if fullDefenseActive}}active{{/if}}" data-action="activateFullDefense" {{#if fullDefenseActive}}disabled{{/if}}>
        <i class="fas fa-shield-virus"></i>
        {{localize "WOR.Defense.FullDefense.Button"}}
      </button>
    </div>
  </div>

  {{!-- Combat Modifiers Reference --}}
  <div class="combat-modifiers-section">
    <h4>{{localize "WOR.Combat.CommonModifiers"}}</h4>
    <div class="modifiers-grid">
      <div class="modifier-item bonus">
        <span class="modifier-name">{{localize "WOR.Combat.Modifier.Flanking"}}</span>
      </div>
      <div class="modifier-item bonus">
        <span class="modifier-name">{{localize "WOR.Combat.Modifier.HighGround"}}</span>
      </div>
      <div class="modifier-item bonus">
        <span class="modifier-name">{{localize "WOR.Combat.Modifier.PointBlank"}}</span>
      </div>
      <div class="modifier-item penalty">
        <span class="modifier-name">{{localize "WOR.Combat.Modifier.Prone"}}</span>
      </div>
      <div class="modifier-item penalty">
        <span class="modifier-name">{{localize "WOR.Combat.Modifier.Cover"}}</span>
      </div>
      <div class="modifier-item penalty">
        <span class="modifier-name">{{localize "WOR.Combat.Modifier.LongRange"}}</span>
      </div>
    </div>
  </div>

  {{!-- Critical Injuries List (collapsed) --}}
  {{#if system.health.criticalInjuries.length}}
  <div class="injuries-section">
    <h4>{{localize "WOR.Health.CriticalInjuries"}} ({{system.health.criticalInjuries.length}})</h4>
    <ul class="injury-list compact">
      {{#each system.health.criticalInjuries}}
      <li class="injury-item" data-injury-id="{{id}}">
        <span class="injury-description">{{#if description}}{{description}}{{else}}{{localize "WOR.Health.CriticalInjury"}}{{/if}}</span>
        <a class="injury-remove" data-action="removeInjury" data-injury-id="{{id}}" title="{{localize 'WOR.Common.Remove'}}">
          <i class="fas fa-times"></i>
        </a>
      </li>
      {{/each}}
    </ul>
  </div>
  {{/if}}
</section>
