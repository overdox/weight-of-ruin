<div class="sheet-body npc-body">
  {{!-- Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    {{#each tabsArray}}
    <a class="item {{cssClass}}" data-tab="{{id}}" data-group="{{group}}">
      {{localize label}}
    </a>
    {{/each}}
  </nav>

  {{!-- Tab Content --}}
  <div class="tab-content npc-content">
    {{!-- Core Tab (Attributes) --}}
    <div class="tab {{#if (eq activeTab 'core')}}active{{/if}}" data-tab="core" data-group="primary">
      {{> "systems/weight-of-ruin/templates/actor/parts/attributes.hbs"}}
    </div>

    {{!-- Skills Tab --}}
    <div class="tab {{#if (eq activeTab 'skills')}}active{{/if}}" data-tab="skills" data-group="primary">
      {{> "systems/weight-of-ruin/templates/actor/parts/skills.hbs"}}
    </div>

    {{!-- Traits Tab --}}
    <div class="tab {{#if (eq activeTab 'traits')}}active{{/if}}" data-tab="traits" data-group="primary">
      <section class="traits-section">
        <div class="traits-header">
          <h3>{{localize "WOR.NPC.Traits"}}</h3>
          {{#if traitPointsMax}}
          <span class="trait-points">
            {{localize "WOR.NPCTrait.TraitPoints"}}: {{traitPointsSpent}} / {{traitPointsMax}}
          </span>
          {{/if}}
        </div>

        {{#if traits.length}}
        <ul class="trait-list">
          {{#each traits}}
          <li class="trait-item" data-trait-id="{{id}}">
            <div class="trait-icon">
              <img src="{{img}}" alt="{{name}}" />
            </div>
            <div class="trait-info">
              <div class="trait-header-row">
                <span class="trait-name">{{name}}</span>
                <div class="trait-tags">
                  {{#if category}}
                  <span class="trait-tag trait-category">{{localize (concat "WOR.NPCTrait.Category." (titleCase category))}}</span>
                  {{/if}}
                  {{#if passive}}
                  <span class="trait-tag trait-passive">{{localize "WOR.NPCTrait.Passive"}}</span>
                  {{/if}}
                  {{#if trigger}}
                  <span class="trait-tag trait-trigger">{{localize (concat "WOR.NPCTrait.Trigger." (titleCase trigger))}}</span>
                  {{/if}}
                  {{#if cooldown}}
                  <span class="trait-tag trait-cooldown">{{cooldown}}</span>
                  {{/if}}
                </div>
              </div>
              {{#if description}}
              <p class="trait-description">{{description}}</p>
              {{/if}}
            </div>
            <div class="trait-actions">
              {{#if hasRoll}}
              <button type="button" class="trait-roll-btn rollable" data-action="rollTrait" data-trait-id="{{id}}" title="{{localize 'WOR.Common.Roll'}}">
                <i class="fas fa-dice-d6"></i>
                {{#if pool}}{{pool}}d6{{/if}}
              </button>
              {{/if}}
              {{#if @root.isEditMode}}
              <a class="item-control" data-action="editItem" data-item-id="{{id}}" title="{{localize 'WOR.Common.Edit'}}">
                <i class="fas fa-edit"></i>
              </a>
              <a class="item-control" data-action="deleteItem" data-item-id="{{id}}" title="{{localize 'WOR.Common.Delete'}}">
                <i class="fas fa-trash"></i>
              </a>
              {{/if}}
            </div>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="empty-notice">{{localize "WOR.Empty.Traits"}}</p>
        {{/if}}
      </section>
    </div>

    {{!-- Combat Tab --}}
    <div class="tab {{#if (eq activeTab 'combat')}}active{{/if}}" data-tab="combat" data-group="primary">
      {{> "systems/weight-of-ruin/templates/actor/parts/combat.hbs"}}

      {{!-- NPC Quick Attacks --}}
      <section class="attacks-section">
        <h3>
          {{localize "WOR.NPC.Attacks"}}
          {{#if isEditMode}}
          <a class="add-control" data-action="addAttack" title="{{localize 'WOR.Common.Add'}}">
            <i class="fas fa-plus"></i>
          </a>
          {{/if}}
        </h3>
        {{#if attacks.length}}
        <ul class="attack-list">
          {{#each attacks}}
          <li class="attack-item" data-attack-id="{{id}}">
            <div class="attack-main">
              {{#if @root.isEditMode}}
              <input type="text" name="attack.name" value="{{name}}" class="attack-name" data-action="editAttack" />
              {{else}}
              <span class="attack-name">{{name}}</span>
              {{/if}}
              <button type="button" class="quick-roll-btn" data-action="quickAttack" data-attack-id="{{id}}" title="{{localize 'WOR.Common.Roll'}}">
                <i class="fas fa-dice-d6"></i>
              </button>
            </div>
            <div class="attack-stats">
              <span class="attack-pool" title="{{localize 'WOR.Roll.Pool'}}">
                {{#if @root.isEditMode}}
                <input type="number" name="attack.pool" value="{{pool}}" min="0" data-action="editAttack" />
                {{else}}
                {{pool}}
                {{/if}}
                d6
              </span>
              <span class="attack-damage" title="{{localize 'WOR.Weapon.Damage'}}">
                <i class="fas fa-tint"></i>
                {{#if @root.isEditMode}}
                <input type="number" name="attack.damage" value="{{damage}}" min="0" data-action="editAttack" />
                {{else}}
                {{damage}}
                {{/if}}
              </span>
              {{#if properties}}
              <span class="attack-properties">{{properties}}</span>
              {{/if}}
            </div>
            {{#if @root.isEditMode}}
            <a class="remove-control" data-action="removeAttack" data-attack-id="{{id}}" title="{{localize 'WOR.Common.Delete'}}">
              <i class="fas fa-trash"></i>
            </a>
            {{/if}}
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="empty-notice">{{localize "WOR.Empty.Attacks"}}</p>
        {{/if}}
      </section>

      {{!-- Notable Abilities --}}
      <section class="abilities-section">
        <h3>
          {{localize "WOR.NPC.Abilities"}}
          {{#if isEditMode}}
          <a class="add-control" data-action="addAbility" title="{{localize 'WOR.Common.Add'}}">
            <i class="fas fa-plus"></i>
          </a>
          {{/if}}
        </h3>
        {{#if abilities.length}}
        <ul class="ability-list">
          {{#each abilities}}
          <li class="ability-item" data-ability-id="{{id}}">
            <div class="ability-header">
              {{#if @root.isEditMode}}
              <input type="text" name="ability.name" value="{{name}}" class="ability-name" data-action="editAbility" />
              {{else}}
              <span class="ability-name">{{name}}</span>
              {{/if}}
              {{#if pool}}
              <button type="button" class="quick-roll-btn" data-action="quickAbility" data-ability-id="{{id}}" title="{{localize 'WOR.Common.Roll'}}">
                <i class="fas fa-dice-d6"></i> {{pool}}d6
              </button>
              {{else}}
              <button type="button" class="show-btn" data-action="quickAbility" data-ability-id="{{id}}" title="{{localize 'WOR.Common.Show'}}">
                <i class="fas fa-comment"></i>
              </button>
              {{/if}}
            </div>
            {{#if @root.isEditMode}}
            <div class="ability-edit">
              <textarea name="ability.description" placeholder="{{localize 'WOR.Common.Description'}}" data-action="editAbility">{{description}}</textarea>
              <div class="ability-roll-settings">
                <label>{{localize "WOR.Roll.Pool"}}:</label>
                <input type="number" name="ability.pool" value="{{pool}}" min="0" placeholder="-" data-action="editAbility" />
                <label>{{localize "WOR.Roll.Difficulty"}}:</label>
                <select name="ability.difficulty" data-action="editAbility">
                  {{#each @root.difficultyOptions}}
                  <option value="{{value}}" {{#if (eq value ../difficulty)}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </div>
            </div>
            <a class="remove-control" data-action="removeAbility" data-ability-id="{{id}}" title="{{localize 'WOR.Common.Delete'}}">
              <i class="fas fa-trash"></i>
            </a>
            {{else}}
            {{#if description}}
            <p class="ability-description">{{description}}</p>
            {{/if}}
            {{/if}}
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="empty-notice">{{localize "WOR.Empty.Abilities"}}</p>
        {{/if}}
      </section>

      {{!-- Morale --}}
      {{#if (or morale.threshold morale.condition isEditMode)}}
      <section class="morale-section">
        <h3>{{localize "WOR.NPC.Morale"}}</h3>
        <div class="morale-fields">
          {{#if isEditMode}}
          <div class="morale-field">
            <label>{{localize "WOR.NPC.MoraleThreshold"}}</label>
            <input type="number" name="system.morale.threshold" value="{{morale.threshold}}" min="0" />
          </div>
          <div class="morale-field">
            <label>{{localize "WOR.NPC.MoraleCondition"}}</label>
            <input type="text" name="system.morale.condition" value="{{morale.condition}}" placeholder="{{localize 'WOR.NPC.MoraleConditionHint'}}" />
          </div>
          {{else}}
          {{#if morale.threshold}}
          <span class="morale-threshold">{{localize "WOR.NPC.FleesAt"}} {{morale.threshold}} {{localize "WOR.Health.Trauma"}}</span>
          {{/if}}
          {{#if morale.condition}}
          <span class="morale-condition">{{morale.condition}}</span>
          {{/if}}
          {{/if}}
        </div>
      </section>
      {{/if}}
    </div>

    {{!-- Inventory Tab --}}
    <div class="tab {{#if (eq activeTab 'inventory')}}active{{/if}}" data-tab="inventory" data-group="primary">
      {{> "systems/weight-of-ruin/templates/actor/parts/inventory.hbs"}}
    </div>

    {{!-- Thaumaturgy Tab --}}
    <div class="tab {{#if (eq activeTab 'thaumaturgy')}}active{{/if}}" data-tab="thaumaturgy" data-group="primary">
      {{> "systems/weight-of-ruin/templates/actor/parts/magic.hbs"}}
    </div>

    {{!-- Profile Tab (NPC Notes) --}}
    <div class="tab {{#if (eq activeTab 'profile')}}active{{/if}}" data-tab="profile" data-group="primary">
      {{!-- GM Tools Section --}}
      {{#if isGM}}
      <section class="gm-tools-section">
        <h3><i class="fas fa-tools"></i> {{localize "WOR.NPC.GMTools"}}</h3>
        <div class="gm-tools-buttons">
          <button type="button" class="wizard-btn" data-action="launchCreationWizard">
            <i class="fas fa-hat-wizard"></i>
            {{localize "WOR.NPCCreation.Title"}}
          </button>
        </div>
      </section>
      {{/if}}

      {{!-- Notes Section --}}
      <section class="notes-section">
        <h3><i class="fas fa-scroll"></i> {{localize "WOR.NPC.Notes"}}</h3>
        {{#if isEditable}}
        <a class="toggle-editor-btn" data-action="toggleNotesEditor" title="{{localize 'WOR.Common.Edit'}}">
          <i class="fas fa-edit"></i>
        </a>
        {{/if}}
        <div class="notes-editor-container" data-field="system.notes">
          {{!-- View mode --}}
          <div class="notes-view">{{{enrichedNotes}}}</div>
          {{!-- Edit mode (hidden by default) --}}
          {{#if isEditable}}
          <div class="notes-edit hidden">
            <prose-mirror name="system.notes" value="{{source.system.notes}}" document-uuid="{{actor.uuid}}"></prose-mirror>
          </div>
          {{/if}}
        </div>
      </section>
    </div>
  </div>
</div>
