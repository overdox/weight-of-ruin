<div class="wor">
  <div class="attack-card {{#if isHit}}hit{{else}}miss{{/if}} {{#if isCritical}}critical{{/if}} {{degreeCss}}">
    {{!-- Header with Attacker Portrait (styled like Defense Card) --}}
    <div class="card-header">
      {{#if attacker.img}}
      <img src="{{attacker.img}}" alt="{{attacker.name}}" class="actor-portrait" />
      {{/if}}
      <div class="header-info">
        <h3 class="attack-roll-title">{{localize "WOR.Combat.AttackRoll"}}</h3>
        <span class="actor-name">{{attacker.name}}</span>
      </div>
    </div>

  {{!-- Result Indicator (styled like Defense Card) --}}
  <div class="result-indicator {{degreeCss}}">
    <div class="result-display attack-result">
      <span class="dice-pool">{{pool.total}}d6</span>
      <span class="result-arrow">→</span>
      {{#if roll.hitsCapped}}
      <span class="hits-count capped" title="{{localize 'WOR.Combat.HitsCapped'}}: {{roll.rawHits}} → {{roll.effectiveHits}}">
        {{roll.effectiveHits}} {{localize "WOR.Roll.Hits"}}
        <span class="precision-cap">({{localize "WOR.Weapon.Precision.Abbrev"}} {{roll.maxHits}})</span>
      </span>
      {{else}}
      <span class="hits-count">{{roll.hits}} {{localize "WOR.Roll.Hits"}}</span>
      {{/if}}
    </div>
  </div>

  {{!-- Weapon Item Display --}}
  <div class="item-display">
    {{#if weapon.img}}
    <img src="{{weapon.img}}" alt="{{weapon.name}}" class="item-image" />
    {{/if}}
    <div class="item-info">
      <h5 class="item-name weapon-name">{{weapon.name}}</h5>
      <span class="item-details">
        {{localize (concat "WOR.Weapon.RangeType." (capitalize weapon.range))}}
      </span>
    </div>
  </div>

  {{!-- Damage Section (styled like result indicator) --}}
  {{#if damage}}
  <div class="damage-section">
    <div class="section-header damage-header">
      <span class="section-title">{{localize "WOR.Combat.Damage"}}</span>
    </div>
    <div class="damage-result">
      <span class="damage-formula">{{damage.formula}}</span>
      <span class="result-arrow">→</span>
      <span class="damage-total">{{damage.finalDamage}} {{localize "WOR.Combat.Dmg"}}</span>
    </div>
  </div>

  {{!-- Modification Effects & Flavour --}}
  {{#if damage.modifications.length}}
  <div class="modifications-display">
    {{#each damage.modifications}}
    {{#if effect}}
    <div class="mod-effect">
      <i class="fas fa-bolt"></i>
      <span>{{effect}}</span>
    </div>
    {{/if}}
    {{#if flavour}}
    <div class="mod-flavour">
      <em>"{{flavour}}"</em>
    </div>
    {{/if}}
    {{/each}}
  </div>
  {{/if}}
  {{/if}}

  {{!-- Miss Message --}}
  {{#unless isHit}}
  <div class="attack-miss">
    <i class="fas fa-shield"></i>
    <span class="miss-message">{{localize "WOR.Combat.AttackMissed"}}</span>
  </div>
  {{/unless}}

  {{!-- Collapsible Details --}}
  <div class="collapsible-section" data-section="attack-details">
    <div class="collapsible-header collapsed" data-action="toggle-collapse">
      <i class="fas fa-chevron-down collapse-icon"></i>
      <span class="section-title">{{localize "WOR.Roll.Details"}}</span>
    </div>
    <div class="collapsible-content collapsed">
      {{!-- Target Info --}}
      {{#if target}}
      <div class="target-info">
        <span class="target-label">{{localize "WOR.Combat.Target"}}:</span>
        <span class="target-name">{{target.name}}</span>
        <span class="target-defense">({{localize "WOR.Defense.Label"}} {{target.defense}}, TT {{targetThreshold}})</span>
      </div>
      {{/if}}

      {{!-- Attack Roll Dice Display (D6 icons) --}}
      <div class="roll-dice attack-dice">
        {{{diceDisplay}}}
      </div>

      {{!-- Pool Breakdown --}}
      <div class="pool-breakdown">
        <div class="breakdown-row">
          <span class="breakdown-label">{{pool.prowess.label}}</span>
          <span class="breakdown-value">{{pool.prowess.value}}</span>
        </div>
        <div class="breakdown-row">
          <span class="breakdown-label">{{pool.skill.name}}</span>
          <span class="breakdown-value">{{pool.skill.rank}}</span>
        </div>
        {{#if pool.quality}}
        <div class="breakdown-row quality">
          <span class="breakdown-label">{{localize "WOR.Weapon.Quality"}}</span>
          <span class="breakdown-value">{{#if (gt pool.quality 0)}}+{{/if}}{{pool.quality}}</span>
        </div>
        {{/if}}
        {{#if pool.modifier}}
        <div class="breakdown-row modifier">
          <span class="breakdown-label">{{localize "WOR.Roll.Modifier"}}</span>
          <span class="breakdown-value">{{#if (gt pool.modifier 0)}}+{{/if}}{{pool.modifier}}</span>
        </div>
        {{/if}}
        <div class="breakdown-row total">
          <span class="breakdown-label">{{localize "WOR.Roll.TotalPool"}}</span>
          <span class="breakdown-value">{{pool.total}}d6</span>
        </div>
      </div>

      {{!-- Precision Info --}}
      <div class="precision-breakdown">
        <div class="breakdown-row">
          <span class="breakdown-label">{{localize "WOR.Weapon.Precision.Label"}}</span>
          <span class="breakdown-value">{{roll.precision.weapon}}</span>
        </div>
        {{#if roll.precision.aim}}
        <div class="breakdown-row">
          <span class="breakdown-label">{{localize "WOR.Combat.Aim"}}</span>
          <span class="breakdown-value">+{{roll.precision.aim}}</span>
        </div>
        {{/if}}
        {{#if roll.precision.talent}}
        <div class="breakdown-row">
          <span class="breakdown-label">{{localize "WOR.Combat.ImprovedPrecision"}}</span>
          <span class="breakdown-value">+{{roll.precision.talent}}</span>
        </div>
        {{/if}}
        <div class="breakdown-row total">
          <span class="breakdown-label">{{localize "WOR.Combat.MaxHits"}}</span>
          <span class="breakdown-value">{{roll.maxHits}}</span>
        </div>
        {{#if roll.hitsCapped}}
        <div class="breakdown-row capped">
          <span class="breakdown-label">{{localize "WOR.Combat.RawHits"}}</span>
          <span class="breakdown-value">{{roll.rawHits}} → {{roll.effectiveHits}}</span>
        </div>
        {{/if}}
      </div>

      {{!-- Damage Breakdown (on hit) --}}
      {{#if damage}}
      <div class="damage-breakdown">
        {{!-- Damage Dice Display --}}
        {{#if damageDiceDisplay}}
        <div class="roll-dice damage-dice">
          {{{damageDiceDisplay}}}
        </div>
        {{/if}}
        <div class="breakdown-row">
          <span class="breakdown-label">{{localize "WOR.Weapon.BaseDamage"}} ({{damage.baseDamage}}{{damage.damageDie}})</span>
          <span class="breakdown-value">{{damage.baseDiceTotal}}</span>
        </div>
        {{#if damage.strengthBonus}}
        <div class="breakdown-row strength">
          <span class="breakdown-label">{{localize "WOR.Attribute.Strength.long"}}</span>
          <span class="breakdown-value">+{{damage.strengthBonus}}</span>
        </div>
        {{/if}}
        {{#if damage.qualityBonus}}
        <div class="breakdown-row quality">
          <span class="breakdown-label">{{localize "WOR.Weapon.Quality"}}</span>
          <span class="breakdown-value">+{{damage.qualityBonus}}</span>
        </div>
        {{/if}}
        {{#each damage.modifications}}
        {{#if display}}
        <div class="breakdown-row modification">
          <span class="breakdown-label">{{localize (concat "WOR.Weapon.Modification." (capitalize category) ".label")}}</span>
          <span class="breakdown-value">{{display}}</span>
        </div>
        {{/if}}
        {{/each}}
        {{#if damage.heavyBonus}}
        <div class="breakdown-row heavy">
          <span class="breakdown-label">{{localize "WOR.Combat.HeavyBonus"}} ({{damage.hits}} {{localize "WOR.Roll.Hits"}})</span>
          <span class="breakdown-value">+{{damage.heavyBonus}}</span>
        </div>
        {{/if}}
        {{#if target.dr}}
        <div class="breakdown-row dr">
          <span class="breakdown-label">{{localize "WOR.Armor.DR.Label"}}</span>
          <span class="breakdown-value">-{{target.dr}}</span>
        </div>
        {{/if}}
        <div class="breakdown-row total">
          <span class="breakdown-label">{{localize "WOR.Combat.TotalDamage"}}</span>
          <span class="breakdown-value">{{damage.finalDamage}}</span>
        </div>
      </div>
      {{/if}}
    </div>
  </div>

  {{!-- Action Buttons (on hit) --}}
  {{#if isHit}}
  {{#if target}}
  <div class="chat-card-buttons">
    <button type="button" class="apply-damage" data-action="apply-damage" data-target-id="{{target.id}}" data-damage="{{damage.traumaDealt}}">
      <i class="fas fa-heart-crack"></i>
      <span>{{localize "WOR.Combat.ApplyDamage"}}</span>
    </button>
  </div>
  {{/if}}
  {{/if}}
  </div>
</div>
